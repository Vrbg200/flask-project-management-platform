// Prisma Schema para SalesFlow

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============= ENUMS =============

enum Rol {
  ADMIN
  GERENTE
  VENDEDOR
}

enum Estado {
  ACTIVO
  INACTIVO
  SUSPENDIDO
}

enum TipoCliente {
  PERSONA
  EMPRESA
}

enum EtapaVenta {
  PROSPECTO
  CALIFICADO
  NEGOCIACION
  CIERRE
  GANADO
  PERDIDO
}

enum EstadoVenta {
  BORRADOR
  ENVIADO
  APROBADO
  RECHAZADO
  COMPLETADO
  CANCELADO
}

enum MetodoPago {
  EFECTIVO
  TARJETA
  TRANSFERENCIA
  CHEQUE
  CREDITO
}

enum TipoActividad {
  LLAMADA
  REUNION
  EMAIL
  TAREA
  NOTA
}

// ============= MODELOS =============

model Usuario {
  id                String         @id @default(uuid())
  email             String         @unique
  password          String
  nombre            String
  apellido          String
  telefono          String?
  avatar            String?
  rol               Rol            @default(VENDEDOR)
  activo            Boolean        @default(true)
  ultimoAcceso      DateTime?
  refreshToken      String?
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relaciones
  oportunidades     Oportunidad[]
  ventas            Venta[]
  actividades       Actividad[]
  notasCliente      NotaCliente[]
  auditoria         Auditoria[]

  @@map("usuarios")
}

model Cliente {
  id                String         @id @default(uuid())
  nombre            String
  email             String         @unique
  telefono          String?
  telefonoSecundario String?
  direccion         String?
  ciudad            String?
  pais              String         @default("Guatemala")
  codigoPostal      String?
  sitioWeb          String?
  
  tipo              TipoCliente    @default(EMPRESA)
  industria         String?
  numeroEmpleados   Int?
  ingresoAnual      Float?
  
  estado            Estado         @default(ACTIVO)
  valorVida         Float          @default(0)
  ultimaInteraccion DateTime?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relaciones
  oportunidades     Oportunidad[]
  ventas            Venta[]
  contactos         Contacto[]
  actividades       Actividad[]
  notas             NotaCliente[]

  @@map("clientes")
  @@index([email])
  @@index([estado])
}

model Contacto {
  id                String         @id @default(uuid())
  clienteId         String
  nombre            String
  apellido          String
  cargo             String?
  email             String
  telefono          String?
  esPrincipal       Boolean        @default(false)
  activo            Boolean        @default(true)
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relaciones
  cliente           Cliente        @relation(fields: [clienteId], references: [id], onDelete: Cascade)

  @@map("contactos")
  @@index([clienteId])
}

model Oportunidad {
  id                String         @id @default(uuid())
  titulo            String
  descripcion       String?
  
  clienteId         String
  vendedorId        String
  
  valor             Float
  etapa             EtapaVenta     @default(PROSPECTO)
  probabilidad      Int            @default(0)
  
  fechaCierre       DateTime
  fechaCierreReal   DateTime?
  razonPerdida      String?
  
  origen            String?
  competidor        String?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relaciones
  cliente           Cliente        @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  vendedor          Usuario        @relation(fields: [vendedorId], references: [id])
  ventas            Venta[]
  actividades       Actividad[]

  @@map("oportunidades")
  @@index([clienteId])
  @@index([vendedorId])
  @@index([etapa])
  @@index([fechaCierre])
}

model Producto {
  id                String         @id @default(uuid())
  codigo            String         @unique
  nombre            String
  descripcion       String?
  
  categoria         String
  subcategoria      String?
  
  precio            Float
  costo             Float?
  margen            Float?
  
  stock             Int            @default(0)
  stockMinimo       Int            @default(0)
  
  unidadMedida      String         @default("unidad")
  
  activo            Boolean        @default(true)
  destacado         Boolean        @default(false)
  
  imagen            String?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relaciones
  itemsVenta        ItemVenta[]

  @@map("productos")
  @@index([categoria])
  @@index([activo])
}

model Venta {
  id                String         @id @default(uuid())
  numeroVenta       String         @unique
  
  clienteId         String
  vendedorId        String
  oportunidadId     String?
  
  fechaVenta        DateTime       @default(now())
  fechaEntrega      DateTime?
  
  subtotal          Float
  descuento         Float          @default(0)
  impuesto          Float          @default(0)
  total             Float
  
  estado            EstadoVenta    @default(COMPLETADO)
  metodoPago        MetodoPago
  
  notas             String?
  terminosCondiciones String?
  
  comisionVendedor  Float?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relaciones
  cliente           Cliente        @relation(fields: [clienteId], references: [id])
  vendedor          Usuario        @relation(fields: [vendedorId], references: [id])
  oportunidad       Oportunidad?   @relation(fields: [oportunidadId], references: [id])
  items             ItemVenta[]

  @@map("ventas")
  @@index([clienteId])
  @@index([vendedorId])
  @@index([fechaVenta])
  @@index([estado])
}

model ItemVenta {
  id                String         @id @default(uuid())
  ventaId           String
  productoId        String
  
  cantidad          Int
  precioUnitario    Float
  descuento         Float          @default(0)
  subtotal          Float
  
  createdAt         DateTime       @default(now())

  // Relaciones
  venta             Venta          @relation(fields: [ventaId], references: [id], onDelete: Cascade)
  producto          Producto       @relation(fields: [productoId], references: [id])

  @@map("items_venta")
  @@index([ventaId])
  @@index([productoId])
}

model Actividad {
  id                String         @id @default(uuid())
  tipo              TipoActividad
  titulo            String
  descripcion       String?
  
  clienteId         String?
  oportunidadId     String?
  usuarioId         String
  
  fechaProgramada   DateTime?
  fechaCompletada   DateTime?
  
  completada        Boolean        @default(false)
  duracion          Int?           // en minutos
  
  resultado         String?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relaciones
  cliente           Cliente?       @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  oportunidad       Oportunidad?   @relation(fields: [oportunidadId], references: [id], onDelete: Cascade)
  usuario           Usuario        @relation(fields: [usuarioId], references: [id])

  @@map("actividades")
  @@index([clienteId])
  @@index([oportunidadId])
  @@index([usuarioId])
  @@index([fechaProgramada])
}

model NotaCliente {
  id                String         @id @default(uuid())
  clienteId         String
  usuarioId         String
  
  contenido         String
  esPrivada         Boolean        @default(false)
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  // Relaciones
  cliente           Cliente        @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  usuario           Usuario        @relation(fields: [usuarioId], references: [id])

  @@map("notas_cliente")
  @@index([clienteId])
}

model Meta {
  id                String         @id @default(uuid())
  nombre            String
  descripcion       String?
  
  tipoMeta          String         // VENTAS, INGRESOS, CLIENTES
  periodoInicio     DateTime
  periodoFin        DateTime
  
  valorObjetivo     Float
  valorActual       Float          @default(0)
  
  usuarioId         String?        // null = meta general
  
  activa            Boolean        @default(true)
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@map("metas")
  @@index([periodoInicio, periodoFin])
}

model Auditoria {
  id                String         @id @default(uuid())
  usuarioId         String
  accion            String         // LOGIN, CREATE, UPDATE, DELETE
  entidad           String         // CLIENTE, VENTA, PRODUCTO, etc.
  entidadId         String?
  
  detalles          Json?
  ip                String?
  userAgent         String?
  
  createdAt         DateTime       @default(now())

  // Relaciones
  usuario           Usuario        @relation(fields: [usuarioId], references: [id])

  @@map("auditoria")
  @@index([usuarioId])
  @@index([createdAt])
  @@index([entidad])
}

model Configuracion {
  id                String         @id @default(uuid())
  clave             String         @unique
  valor             Json
  
  descripcion       String?
  
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt

  @@map("configuracion")
}
